# アーキテクチャ基本設計書

## 案件情報

| 項目 | 内容 |
|------|------|
| 案件名 | H2 Database移行 |
| 案件ID | 202512_H2DB移行 |
| 作成日 | 2025-12-22 |
| 関連要件整理書 | [requirements.md](./requirements.md) |

---

## 1. 概要

### 1.1 本設計書の目的

H2 Database移行に伴うシステムアーキテクチャの変更を定義する。現行のインメモリ方式から永続化層を追加したレイヤードアーキテクチャへの移行方針を明確にする。

### 1.2 設計方針

| 方針 | 説明 |
|------|------|
| 最小変更 | 既存のAPI・画面への影響を最小化 |
| レイヤー分離 | データアクセス層をRepository層として独立 |
| 標準技術 | Spring Data JPA + H2の標準的な構成 |
| 拡張性 | 将来のRDBMS移行を容易にする構成 |

---

## 2. 現行アーキテクチャ

### 2.1 システム構成（現行）

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント                            │
│                   (ブラウザ / REST Client)                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Spring Boot Application                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                  Controller Layer                      │  │
│  │    TodoController.java / HelloController.java          │  │
│  └───────────────────────────────────────────────────────┘  │
│                              │                               │
│                              ▼                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   Service Layer                        │  │
│  │                  TodoService.java                      │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  ConcurrentHashMap<Long, Todo>  ←データ保持     │  │  │
│  │  │  AtomicLong idGenerator         ←ID採番        │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 現行の問題点

| 問題 | 影響 |
|------|------|
| データ揮発性 | アプリ再起動でデータ消失 |
| SQL非対応 | 柔軟なデータ操作不可 |
| 層の混在 | Serviceにデータ保持ロジックが混在 |
| 拡張性 | 他DBへの移行が困難 |

---

## 3. 移行後アーキテクチャ

### 3.1 システム構成（移行後）

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント                            │
│                   (ブラウザ / REST Client)                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Spring Boot Application                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              Controller Layer (変更なし)               │  │
│  │    TodoController.java / HelloController.java          │  │
│  └───────────────────────────────────────────────────────┘  │
│                              │                               │
│                              ▼                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   Service Layer                        │  │
│  │                  TodoService.java                      │  │
│  │            ※Repository経由でデータアクセス              │  │
│  └───────────────────────────────────────────────────────┘  │
│                              │                               │
│                              ▼                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │               Repository Layer (新規)                  │  │
│  │                TodoRepository.java                     │  │
│  │          (Spring Data JPA Repository)                  │  │
│  └───────────────────────────────────────────────────────┘  │
│                              │                               │
│                              │ JPA/JDBC                      │
│                              ▼                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   H2 Database                          │  │
│  │              (ファイルモード: ./data/tododb)            │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ ファイルI/O
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    ファイルシステム                          │
│                   ./data/tododb.mv.db                        │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 H2 Console アクセス

```
┌─────────────────────────────────────────────────────────────┐
│                   開発者ブラウザ                             │
│               http://localhost:8080/h2-console               │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP (ローカルのみ)
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    H2 Console Servlet                        │
│                   (Spring Boot組み込み)                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ JDBC
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    H2 Database                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. レイヤー詳細

### 4.1 レイヤー構成

| レイヤー | 責務 | 主要クラス |
|---------|------|-----------|
| Controller | HTTPリクエスト/レスポンス処理 | TodoController |
| Service | ビジネスロジック | TodoService |
| Repository | データアクセス抽象化 | TodoRepository (新規) |
| Entity | データモデル | Todo |

### 4.2 依存関係

```
Controller → Service → Repository → Database
    ↓           ↓           ↓
  Entity     Entity      Entity
```

- 上位レイヤーは下位レイヤーにのみ依存
- EntityはすべてのレイヤーからアクセスされるDTO/モデル

### 4.3 レイヤー間の契約

| 呼び出し元 | 呼び出し先 | インターフェース |
|-----------|-----------|-----------------|
| Controller | Service | メソッド呼び出し（DI） |
| Service | Repository | JpaRepository継承インターフェース |
| Repository | Database | JPA/JDBC（自動生成） |

---

## 5. 技術スタック

### 5.1 フレームワーク・ライブラリ

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| フレームワーク | Spring Boot | 3.2.0 | アプリケーション基盤 |
| Web | Spring Web | (Boot管理) | REST API |
| ORM | Spring Data JPA | (Boot管理) | データアクセス抽象化 |
| ORM実装 | Hibernate | (Boot管理) | JPA実装 |
| Database | H2 Database | (Boot管理) | 組み込みSQLデータベース |
| テスト | Spring Boot Test | (Boot管理) | テストサポート |

### 5.2 ランタイム環境

| 項目 | 値 |
|------|-----|
| Java | 21 |
| ビルドツール | Maven |
| 実行形態 | 組み込みTomcat |

---

## 6. データフロー

### 6.1 ToDo作成フロー

```
1. クライアント → POST /api/todos (JSON)
2. TodoController.createTodo()
   └→ バリデーション（title必須）
3. TodoService.createTodo()
   └→ 現行: Map.put() → 移行後: Repository.save()
4. TodoRepository.save() [新規]
   └→ JPA経由でINSERT実行
5. H2 Database
   └→ TODOテーブルにレコード追加
6. レスポンス ← 作成されたToDo (JSON)
```

### 6.2 ToDo取得フロー（フィルタあり）

```
1. クライアント → GET /api/todos?completed=false
2. TodoController.getAllTodos()
3. TodoService.getTodosByCompleted()
   └→ 現行: Stream filter → 移行後: Repository.findByCompleted()
4. TodoRepository.findByCompleted() [新規]
   └→ JPA経由でSELECT実行
5. H2 Database
   └→ WHERE句で絞り込み
6. レスポンス ← ToDoリスト (JSON)
```

---

## 7. 永続化設計

### 7.1 H2 Database設定

| 設定項目 | 値 | 説明 |
|---------|-----|------|
| 接続URL | jdbc:h2:file:./data/tododb | ファイルモード |
| モード | 組み込み | 別プロセス不要 |
| 永続化 | 自動 | トランザクションコミット時 |

### 7.2 ファイル構成

```
project-root/
├── data/
│   ├── tododb.mv.db      # メインデータファイル
│   └── tododb.trace.db   # トレースログ（オプション）
└── src/
    └── ...
```

### 7.3 スキーマ管理

| 項目 | 設定 |
|------|------|
| ddl-auto | update |
| 初回起動 | Entityからテーブル自動生成 |
| 以降 | 差分検出・自動更新 |

---

## 8. 設計原則

### 8.1 適用パターン

| パターン | 適用箇所 | 説明 |
|---------|---------|------|
| Repository Pattern | TodoRepository | データアクセスの抽象化 |
| Dependency Injection | 全レイヤー | Spring DIコンテナ利用 |
| DTO Pattern | Todo Entity | レイヤー間データ受け渡し |

### 8.2 SOLID原則の適用

| 原則 | 適用内容 |
|------|---------|
| 単一責任 | Service=ロジック、Repository=データアクセス分離 |
| 開放閉鎖 | Repository変更でService影響なし |
| 依存性逆転 | RepositoryインターフェースへのDI |

---

## 9. 非機能設計

### 9.1 性能

| 項目 | 設計 |
|------|------|
| コネクション | 組み込みのためオーバーヘッドなし |
| キャッシュ | Hibernateの1次キャッシュ利用 |
| インデックス | PK（ID）に自動作成 |

### 9.2 セキュリティ

| 項目 | 設計 |
|------|------|
| H2 Console | settings.allow-web-admins=false（デフォルト） |
| SQLインジェクション | JPA/PreparedStatement利用で防止 |
| ファイル保護 | アプリケーションユーザーのみアクセス |

### 9.3 保守性

| 項目 | 設計 |
|------|------|
| ログ | Spring Boot標準ログ出力 |
| 設定外部化 | application.propertiesで環境依存設定管理 |
| テスト | 統合テストでDB含めた検証 |

---

## 10. 移行による影響範囲

### 10.1 変更あり

| 対象 | 変更内容 |
|------|---------|
| pom.xml | 依存関係追加 |
| Todo.java | JPAアノテーション追加 |
| TodoService.java | Repository利用に変更 |
| application.properties | H2設定追加 |
| TodoRepository.java | 新規作成 |
| テストコード | 統合テスト対応 |

### 10.2 変更なし

| 対象 | 理由 |
|------|------|
| TodoController.java | Service呼び出しのみで変更なし |
| HelloController.java | ToDo機能と無関係 |
| フロントエンド | APIインターフェース維持 |

### 10.3 ディレクトリ追加

| パス | 用途 |
|------|------|
| ./data/ | H2データファイル格納（.gitignore推奨） |

---

## 11. 将来の拡張性

### 11.1 他RDBMS移行

```
現在の構成:
  Repository → H2 Database

将来の構成（例: PostgreSQL移行時）:
  Repository → PostgreSQL

変更点:
  - application.properties: 接続URL変更
  - pom.xml: PostgreSQLドライバ追加
  - Serviceコード: 変更なし
```

### 11.2 Profile切り替え

```properties
# application-dev.properties (開発)
spring.datasource.url=jdbc:h2:file:./data/tododb

# application-prod.properties (本番)
spring.datasource.url=jdbc:postgresql://localhost:5432/todo
```

---

## 改版履歴

| 版数 | 日付 | 変更内容 | 変更者 |
|------|------|----------|--------|
| 1.0 | 2025-12-22 | 初版作成 | - |
