# バックエンド基本設計書

## 案件情報

| 項目 | 内容 |
|------|------|
| 案件名 | 担当者機能追加 |
| 案件ID | 202512_担当者機能追加 |
| 作成日 | 2025-12-22 |
| 関連要件整理書 | [requirements.md](./requirements.md) |

---

## 1. 概要

### 1.1 本設計書の目的

担当者機能追加に伴うバックエンドの機能・データ・APIの基本設計を定義する。

### 1.2 バックエンドの役割

| 責務 | 説明 |
|------|------|
| データ管理 | ユーザーマスタの管理、ToDoと担当者の関連付け |
| ビジネスロジック | ユーザーCRUD処理、担当者の妥当性検証 |
| API提供 | ユーザー管理API、既存ToDo APIの拡張 |
| バリデーション | ユーザー名の必須・一意チェック、文字数制限 |

---

## 2. 機能要件

### 2.1 機能一覧

| ID | 機能名 | 概要 | 対応US |
|----|--------|------|--------|
| F-001 | 担当者選択 | ToDoに担当者（ユーザーID）を紐付ける | US-001, US-002, US-003 |
| F-002 | 担当者表示 | ToDoに紐付いた担当者名を返却する | US-004 |
| F-003 | ユーザー登録 | 新規ユーザーをマスタに登録 | US-005 |
| F-004 | ユーザー一覧取得 | 登録済みユーザー一覧を返却 | US-006 |
| F-005 | ユーザー削除 | ユーザーをマスタから削除 | US-007 |

---

## 3. データ要件

### 3.1 データ構造

| データ名 | 概要 | 永続化 |
|---------|------|--------|
| User | ユーザーマスタ | 要（H2 Database） |
| Todo | ToDoデータ（担当者ID追加） | 要（H2 Database） |

### 3.2 エンティティ

#### User（新規）

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | Long | 自動 | 一意識別子（主キー） |
| name | String | 必須 | ユーザー名（一意制約） |
| createdAt | LocalDateTime | 自動 | 作成日時 |

#### Todo（変更）

| 属性 | 型 | 必須 | 説明 | 変更 |
|------|-----|------|------|------|
| id | Long | 自動 | 一意識別子 | 既存 |
| title | String | 必須 | タイトル | 既存 |
| description | String | 任意 | 説明 | 既存 |
| completed | boolean | 自動 | 完了フラグ | 既存 |
| createdAt | LocalDateTime | 自動 | 作成日時 | 既存 |
| assigneeId | Long | 任意 | 担当者ID | **追加** |
| assigneeName | String | - | 担当者名（レスポンス用） | **追加** |

### 3.3 テーブル定義

#### USERテーブル（新規）

| カラム名 | データ型 | NULL | デフォルト | 制約 |
|---------|----------|------|-----------|------|
| ID | BIGINT | NO | AUTO_INCREMENT | PK |
| NAME | VARCHAR(100) | NO | - | UNIQUE |
| CREATED_AT | TIMESTAMP | NO | CURRENT_TIMESTAMP | - |

#### TODOテーブル（変更）

| カラム名 | データ型 | NULL | 説明 | 変更 |
|---------|----------|------|------|------|
| ASSIGNEE_ID | BIGINT | YES | 担当者ID（USERへのFK） | **追加** |

---

## 4. API要件

### 4.1 新規エンドポイント（ユーザー管理）

| メソッド | パス | 機能 | 対応機能 |
|---------|------|------|----------|
| GET | /api/users | ユーザー一覧取得 | F-004 |
| GET | /api/users/{id} | ユーザー単一取得 | F-004 |
| POST | /api/users | ユーザー登録 | F-003 |
| DELETE | /api/users/{id} | ユーザー削除 | F-005 |

### 4.2 変更エンドポイント（ToDo API）

| メソッド | パス | 変更内容 |
|---------|------|---------|
| GET | /api/todos | レスポンスにassigneeId, assigneeNameを追加 |
| GET | /api/todos/{id} | レスポンスにassigneeId, assigneeNameを追加 |
| POST | /api/todos | リクエストにassigneeIdを追加 |
| PUT | /api/todos/{id} | リクエストにassigneeIdを追加 |

---

## 5. API詳細

### 5.1 GET /api/users - ユーザー一覧取得

**概要**: 全ユーザーを作成日時順で取得

**レスポンス**:

```json
[
  {
    "id": 1,
    "name": "山田太郎",
    "createdAt": "2025-12-22T10:00:00"
  },
  {
    "id": 2,
    "name": "鈴木花子",
    "createdAt": "2025-12-22T11:00:00"
  }
]
```

| ステータス | 条件 |
|-----------|------|
| 200 | 成功（空配列も含む） |

---

### 5.2 GET /api/users/{id} - ユーザー単一取得

**概要**: 指定IDのユーザーを取得

**パスパラメータ**:

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | Long | ユーザーID |

**レスポンス**:

```json
{
  "id": 1,
  "name": "山田太郎",
  "createdAt": "2025-12-22T10:00:00"
}
```

| ステータス | 条件 |
|-----------|------|
| 200 | 成功 |
| 404 | 指定IDが存在しない |

---

### 5.3 POST /api/users - ユーザー登録

**概要**: 新しいユーザーを登録

**リクエストボディ**:

```json
{
  "name": "山田太郎"
}
```

| フィールド | 型 | 必須 | 最大文字数 | 説明 |
|-----------|-----|------|-----------|------|
| name | String | 必須 | 100 | ユーザー名（一意） |

**レスポンス**:

```json
{
  "id": 1,
  "name": "山田太郎",
  "createdAt": "2025-12-22T10:00:00"
}
```

| ステータス | 条件 |
|-----------|------|
| 201 | 作成成功 |
| 400 | ユーザー名未入力 |
| 409 | ユーザー名重複 |

---

### 5.4 DELETE /api/users/{id} - ユーザー削除

**概要**: 指定ユーザーを削除

**パスパラメータ**:

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | Long | ユーザーID |

| ステータス | 条件 |
|-----------|------|
| 204 | 削除成功 |
| 404 | 指定IDが存在しない |

**削除時の動作**:
- 該当ユーザーが担当者として設定されているToDoは、担当者がNULL（未割当）になる

---

### 5.5 ToDo API変更

#### Todoオブジェクト（変更後）

```json
{
  "id": 1,
  "title": "タスク名",
  "description": "説明",
  "completed": false,
  "createdAt": "2025-12-22T10:00:00",
  "assigneeId": 1,
  "assigneeName": "山田太郎"
}
```

| フィールド | 型 | 説明 | 変更 |
|-----------|-----|------|------|
| id | Long | 一意識別子 | 既存 |
| title | String | タイトル | 既存 |
| description | String | 説明 | 既存 |
| completed | boolean | 完了フラグ | 既存 |
| createdAt | LocalDateTime | 作成日時 | 既存 |
| assigneeId | Long | 担当者ID（null可） | **追加** |
| assigneeName | String | 担当者名（null可） | **追加** |

#### POST /api/todos リクエスト（変更後）

```json
{
  "title": "タスク名",
  "description": "説明",
  "assigneeId": 1
}
```

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| title | String | 必須 | タイトル |
| description | String | 任意 | 説明 |
| assigneeId | Long | 任意 | 担当者ID |

#### PUT /api/todos/{id} リクエスト（変更後）

```json
{
  "title": "更新後タイトル",
  "description": "更新後説明",
  "completed": true,
  "assigneeId": 2
}
```

---

## 6. クラス構成

### 6.1 追加クラス

| クラス名 | レイヤー | 責務 |
|---------|---------|------|
| User | Entity | ユーザーデータ構造定義 |
| UserController | Controller | ユーザーAPI提供 |
| UserService | Service | ユーザービジネスロジック |
| UserMapper | Mapper | ユーザーデータアクセス |

### 6.2 変更クラス

| クラス名 | 変更内容 |
|---------|---------|
| Todo | assigneeId, assigneeNameフィールド追加 |
| TodoMapper | assigneeId対応のSQL変更 |
| TodoService | assigneeName取得ロジック追加 |
| TodoController | assigneeIdのリクエスト/レスポンス対応 |

### 6.3 クラス図（追加部分）

```
┌────────────────────────┐
│    UserController      │
│    (@RestController)   │
│                        │
│ + getAllUsers()        │
│ + getUserById()        │
│ + createUser()         │
│ + deleteUser()         │
└───────────┬────────────┘
            │ @Autowired
            ▼
┌────────────────────────┐
│     UserService        │
│     (@Service)         │
│                        │
│ - userMapper: UserMapper│
│                        │
│ + getAllUsers()        │
│ + getUserById()        │
│ + createUser()         │
│ + deleteUser()         │
│ + existsByName()       │
└───────────┬────────────┘
            │ @Autowired
            ▼
┌────────────────────────┐
│      UserMapper        │
│      (@Mapper)         │
│                        │
│ + selectAll()          │
│ + selectById()         │
│ + selectByName()       │
│ + insert()             │
│ + deleteById()         │
│ + count()              │
└───────────┬────────────┘
            │ uses
            ▼
┌────────────────────────┐
│         User           │
│       (Entity)         │
│                        │
│ - id: Long             │
│ - name: String         │
│ - createdAt: LocalDateTime│
└────────────────────────┘
```

---

## 7. ビジネスルール

### 7.1 ユーザー登録

| ルールID | ルール | 対応 |
|---------|--------|------|
| BR-001 | ユーザー名は必須 | 400エラー |
| BR-002 | ユーザー名は100文字以内 | 400エラー |
| BR-003 | ユーザー名は一意 | 409エラー |

### 7.2 ユーザー削除

| ルールID | ルール | 対応 |
|---------|--------|------|
| BR-004 | 削除対象が存在しない | 404エラー |
| BR-005 | 担当者として使用中でも削除可能 | ToDoのassigneeIdをNULLに |

### 7.3 ToDo担当者設定

| ルールID | ルール | 対応 |
|---------|--------|------|
| BR-006 | 担当者IDは任意 | NULL許可 |
| BR-007 | 存在しないユーザーIDは設定不可 | 400エラー |

---

## 8. 非機能要件

### 8.1 性能要件

| 項目 | 要件 |
|------|------|
| API応答時間 | 既存と同等 |
| 同時アクセス | H2のロック機構で保証 |

### 8.2 セキュリティ要件

| 項目 | 対応 |
|------|------|
| 認証 | なし（既存踏襲） |
| 入力バリデーション | ユーザー名の必須・文字数・一意チェック |
| XSS対策 | フロントエンドでのエスケープ |

---

## 9. 制約条件

| 項目 | 制約 |
|------|------|
| データ保存 | H2 Database（既存踏襲） |
| O/Rマッパー | MyBatis（既存踏襲） |
| 外部キー制約 | なし（アプリケーションレベルで整合性維持） |

---

## 10. エラーハンドリング

| エラー | HTTPステータス | レスポンス |
|--------|--------------|-----------|
| ユーザー名未入力 | 400 | Bad Request |
| ユーザー名重複 | 409 | Conflict |
| ユーザー未発見 | 404 | Not Found |
| 担当者ID不正 | 400 | Bad Request |

---

## 改版履歴

| 版数 | 日付 | 変更内容 | 変更者 |
|------|------|----------|--------|
| 1.0 | 2025-12-22 | 初版作成 | - |
