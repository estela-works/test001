import{d as I,f as W,b as u,a as t,g as A,v as j,h as nt,i as Q,F as U,j as V,o as r,t as d,_ as k,k as C,n as G,l as L,m as J,c as M,p as B,q as st,s as N,u as X,x as Y,y as $,z as Z,T as lt,e as O,w as tt,A as at,B as rt,r as dt}from"./index-D1rnpmQv.js";import{u as et}from"./todoStore-CnlSoGBi.js";import{u as ot}from"./userStore-0NiYegvr.js";import{g as it}from"./projectService--dyVZNgQ.js";import{E as ut,L as ct}from"./ErrorMessage-B4CrD3zU.js";import"./apiClient-DXSJKec5.js";const w={FETCH_FAILED:"コメントの取得に失敗しました",CREATE_FAILED:"コメントの投稿に失敗しました",DELETE_FAILED:"コメントの削除に失敗しました",VALIDATION_ERROR:"入力内容に誤りがあります",TODO_NOT_FOUND:"チケットが見つかりません",NOT_FOUND:"コメントが見つかりません",NETWORK_ERROR:"通信エラーが発生しました"},R={MAX_CONTENT_LENGTH:2e3,MIN_CONTENT_LENGTH:1,CONTENT_PLACEHOLDER:"コメントを入力してください（最大2000文字）",USER_PLACEHOLDER:"投稿者を選択してください"};function mt(s){const l={};return s.userId||(l.userId="投稿者を選択してください"),!s.content||s.content.trim()===""?l.content="コメントを入力してください（最大2000文字）":s.content.length>R.MAX_CONTENT_LENGTH&&(l.content=`コメントは${R.MAX_CONTENT_LENGTH}文字以内で入力してください`),l}const vt={class:"add-todo card"},pt={class:"date-inputs"},ft={class:"date-field"},_t={class:"date-field"},gt={class:"assignee-field"},Tt=["value"],yt=I({__name:"TodoForm",props:{users:{},projectId:{}},emits:["submit"],setup(s,{emit:l}){const e=s,v=l,o=W({title:"",description:"",startDate:"",dueDate:"",assigneeId:""}),_=()=>o.title.trim()?o.startDate&&o.dueDate&&o.startDate>o.dueDate?(alert("終了日は開始日以降を指定してください"),!1):!0:(alert("タイトルを入力してください"),!1),n=()=>{o.title="",o.description="",o.startDate="",o.dueDate="",o.assigneeId=""},g=()=>{if(!_())return;const p={title:o.title.trim(),description:o.description.trim()||void 0,startDate:o.startDate||null,dueDate:o.dueDate||null,assigneeId:o.assigneeId?Number(o.assigneeId):null,projectId:e.projectId?Number(e.projectId):null};v("submit",p),n()};return(p,a)=>(r(),u("div",vt,[a[9]||(a[9]=t("h3",null,"新しいToDoを追加",-1)),A(t("input",{"onUpdate:modelValue":a[0]||(a[0]=i=>o.title=i),type:"text",placeholder:"タイトルを入力してください",onKeypress:nt(g,["enter"])},null,544),[[j,o.title]]),A(t("textarea",{"onUpdate:modelValue":a[1]||(a[1]=i=>o.description=i),rows:"3",placeholder:"説明を入力してください（オプション）"},null,512),[[j,o.description]]),t("div",pt,[t("div",ft,[a[5]||(a[5]=t("label",null,"開始日:",-1)),A(t("input",{"onUpdate:modelValue":a[2]||(a[2]=i=>o.startDate=i),type:"date"},null,512),[[j,o.startDate]])]),t("div",_t,[a[6]||(a[6]=t("label",null,"終了日:",-1)),A(t("input",{"onUpdate:modelValue":a[3]||(a[3]=i=>o.dueDate=i),type:"date"},null,512),[[j,o.dueDate]])])]),t("div",gt,[a[8]||(a[8]=t("label",null,"担当者:",-1)),A(t("select",{"onUpdate:modelValue":a[4]||(a[4]=i=>o.assigneeId=i)},[a[7]||(a[7]=t("option",{value:""},"未割当",-1)),(r(!0),u(U,null,V(s.users,i=>(r(),u("option",{key:i.id,value:i.id},d(i.name),9,Tt))),128))],512),[[Q,o.assigneeId]])]),t("button",{class:"btn-primary",onClick:g},"追加")]))}}),Et=k(yt,[["__scopeId","data-v-87686a9d"]]),ht={key:0},bt={key:1,class:"date-range"},Ct={class:"actions"},Dt=I({__name:"TodoItem",props:{todo:{}},emits:["toggle","delete","click"],setup(s,{emit:l}){const e=s,v=l,o=C(()=>{if(!e.todo.startDate&&!e.todo.dueDate)return"";const g=e.todo.startDate||"未定",p=e.todo.dueDate||"未定";return`${g} 〜 ${p}`}),_=C(()=>new Date(e.todo.createdAt).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})),n=()=>{confirm("このToDoを削除しますか？")&&v("delete",e.todo.id)};return(g,p)=>(r(),u("div",{class:G(["todo-item card",{completed:s.todo.completed}]),onClick:p[1]||(p[1]=a=>g.$emit("click",s.todo.id))},[t("h3",null,d(s.todo.title),1),s.todo.description?(r(),u("p",ht,d(s.todo.description),1)):L("",!0),o.value?(r(),u("p",bt,"期間: "+d(o.value),1)):L("",!0),t("p",{class:G(["assignee",{unassigned:!s.todo.assigneeName}])}," 担当: "+d(s.todo.assigneeName||"未割当"),3),t("p",null,[t("small",null,"作成日: "+d(_.value),1)]),t("div",Ct,[t("button",{class:"toggle-btn",onClick:p[0]||(p[0]=J(a=>g.$emit("toggle",s.todo.id),["stop"]))},d(s.todo.completed?"未完了にする":"完了にする"),1),t("button",{class:"delete-btn btn-danger",onClick:J(n,["stop"])},"削除")])],2))}}),wt=k(Dt,[["__scopeId","data-v-85b564be"]]),$t={class:"todo-list"},It={key:0,class:"empty-message"},kt=I({__name:"TodoList",props:{todos:{}},emits:["toggle","delete","click"],setup(s){return(l,e)=>(r(),u("div",$t,[s.todos.length===0?(r(),u("p",It,"ToDoアイテムがありません。")):L("",!0),(r(!0),u(U,null,V(s.todos,v=>(r(),M(wt,{key:v.id,todo:v,onToggle:e[0]||(e[0]=o=>l.$emit("toggle",o)),onDelete:e[1]||(e[1]=o=>l.$emit("delete",o)),onClick:e[2]||(e[2]=o=>l.$emit("click",o))},null,8,["todo"]))),128))]))}}),Nt=k(kt,[["__scopeId","data-v-48d2b790"]]),Ot={class:"stats card"},Lt=I({__name:"TodoStats",props:{total:{},completed:{},pending:{}},setup(s){return(l,e)=>(r(),u("div",Ot,[t("span",null,[e[0]||(e[0]=B("総数: ",-1)),t("strong",null,d(s.total),1)]),t("span",null,[e[1]||(e[1]=B("完了: ",-1)),t("strong",null,d(s.completed),1)]),t("span",null,[e[2]||(e[2]=B("未完了: ",-1)),t("strong",null,d(s.pending),1)])]))}}),At=k(Lt,[["__scopeId","data-v-d928c6ad"]]),St={class:"filter-buttons"},Ft=["onClick"],Rt=I({__name:"TodoFilter",props:{modelValue:{}},emits:["update:modelValue"],setup(s){const l=[{value:"all",label:"すべて"},{value:"pending",label:"未完了"},{value:"completed",label:"完了済み"}];return(e,v)=>(r(),u("div",St,[(r(),u(U,null,V(l,o=>t("button",{key:o.value,class:G({active:s.modelValue===o.value}),onClick:_=>e.$emit("update:modelValue",o.value)},d(o.label),11,Ft)),64))]))}}),Mt=k(Rt,[["__scopeId","data-v-31844975"]]),K=st("comment",()=>{const s=N([]),l=N(!1),e=N(null),v=N(null),o=C(()=>s.value.length),_=C(()=>s.value.length>0),n=C(()=>[...s.value].sort((E,f)=>new Date(f.createdAt).getTime()-new Date(E.createdAt).getTime()));async function g(E){l.value=!0,e.value=null,v.value=E;try{const f=await fetch(`/api/todos/${E}/comments`);if(!f.ok)throw f.status===404?new Error(w.TODO_NOT_FOUND):new Error(w.FETCH_FAILED);const h=await f.json();s.value=h}catch(f){throw e.value=f instanceof Error?f.message:w.FETCH_FAILED,s.value=[],f}finally{l.value=!1}}async function p(E,f){l.value=!0,e.value=null;try{const h=await fetch(`/api/todos/${E}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(!h.ok)throw h.status===400?new Error(w.VALIDATION_ERROR):h.status===404?new Error(w.TODO_NOT_FOUND):new Error(w.CREATE_FAILED);const m=await h.json();return s.value.unshift(m),m}catch(h){throw e.value=h instanceof Error?h.message:w.CREATE_FAILED,h}finally{l.value=!1}}async function a(E){l.value=!0,e.value=null;try{const f=await fetch(`/api/comments/${E}`,{method:"DELETE"});if(!f.ok)throw f.status===404?new Error(w.NOT_FOUND):new Error(w.DELETE_FAILED);s.value=s.value.filter(h=>h.id!==E)}catch(f){throw e.value=f instanceof Error?f.message:w.DELETE_FAILED,f}finally{l.value=!1}}function i(){s.value=[],e.value=null,v.value=null}function T(){e.value=null}function b(){s.value=[],l.value=!1,e.value=null,v.value=null}return{comments:s,loading:l,error:e,currentTodoId:v,commentCount:o,hasComments:_,sortedComments:n,fetchComments:g,createComment:p,deleteComment:a,clearComments:i,clearError:T,$reset:b}}),jt={class:"comment-item"},Ut={class:"comment-header"},Vt={class:"author"},xt={class:"timestamp"},Ht={class:"comment-content"},Pt=I({__name:"CommentItem",props:{comment:{}},emits:["delete"],setup(s,{emit:l}){const e=s,v=l,o=C(()=>_(e.comment.createdAt));function _(g){const p=new Date,a=new Date(g),i=p.getTime()-a.getTime(),T=Math.floor(i/6e4),b=Math.floor(i/36e5),E=Math.floor(i/864e5);return T<1?"たった今":T<60?`${T}分前`:b<24?`${b}時間前`:E<7?`${E}日前`:a.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function n(){v("delete",e.comment.id)}return(g,p)=>(r(),u("div",jt,[t("div",Ut,[t("span",Vt,d(s.comment.userName||"削除されたユーザー"),1),p[0]||(p[0]=t("span",{class:"separator"},"•",-1)),t("span",xt,d(o.value),1),t("button",{class:"btn-delete",onClick:n,"aria-label":"削除"}," 削除 ")]),t("div",Ht,d(s.comment.content),1)]))}}),Bt=k(Pt,[["__scopeId","data-v-044b5849"]]),Gt={class:"comment-list"},Jt={key:0,class:"loading"},Xt={key:1,class:"error"},Kt={key:2,class:"empty"},qt={key:3,class:"comments"},zt=I({__name:"CommentList",props:{todoId:{}},setup(s){const l=s,e=K();X(async()=>{try{await e.fetchComments(l.todoId)}catch{}}),Y(()=>{e.clearComments()});async function v(o){if(confirm("このコメントを削除してもよろしいですか?"))try{await e.deleteComment(o)}catch{alert("コメントの削除に失敗しました")}}return(o,_)=>(r(),u("div",Gt,[$(e).loading?(r(),u("div",Jt," 読み込み中... ")):$(e).error?(r(),u("div",Xt,d($(e).error),1)):$(e).hasComments?(r(),u("div",qt,[(r(!0),u(U,null,V($(e).sortedComments,n=>(r(),M(Bt,{key:n.id,comment:n,onDelete:v},null,8,["comment"]))),128))])):(r(),u("div",Kt," コメントはまだありません "))]))}}),Wt=k(zt,[["__scopeId","data-v-bbc0d4dd"]]),Qt={class:"form-group"},Yt=["placeholder","disabled","maxlength"],Zt={key:0,class:"error-message"},te={class:"char-count"},ee={class:"form-row"},oe={class:"form-group"},ne=["disabled"],se={value:null},le=["value"],ae={key:0,class:"error-message"},re=["disabled"],de=I({__name:"CommentForm",props:{todoId:{}},emits:["commentCreated"],setup(s,{emit:l}){const e=s,v=l,o=K(),_=ot(),n=W({content:"",userId:null,submitting:!1,errors:{}}),g=C(()=>_.users),p=C(()=>n.content.trim()!==""&&n.userId!==null);X(async()=>{await _.fetchUsers()});async function a(){const i={userId:n.userId??void 0,content:n.content};if(n.errors=mt(i),!(Object.keys(n.errors).length>0)){n.submitting=!0;try{await o.createComment(e.todoId,i),n.content="",n.userId=null,n.errors={},v("commentCreated")}catch{alert("コメントの投稿に失敗しました")}finally{n.submitting=!1}}}return(i,T)=>(r(),u("form",{class:"comment-form",onSubmit:J(a,["prevent"])},[t("div",Qt,[T[2]||(T[2]=t("label",{for:"comment-content"},"コメント",-1)),A(t("textarea",{id:"comment-content","onUpdate:modelValue":T[0]||(T[0]=b=>n.content=b),placeholder:$(R).CONTENT_PLACEHOLDER,rows:"4",disabled:n.submitting,maxlength:$(R).MAX_CONTENT_LENGTH},null,8,Yt),[[j,n.content]]),n.errors.content?(r(),u("div",Zt,d(n.errors.content),1)):L("",!0),t("div",te,d(n.content.length)+" / "+d($(R).MAX_CONTENT_LENGTH),1)]),t("div",ee,[t("div",oe,[T[3]||(T[3]=t("label",{for:"comment-user"},"投稿者",-1)),A(t("select",{id:"comment-user","onUpdate:modelValue":T[1]||(T[1]=b=>n.userId=b),disabled:n.submitting},[t("option",se,d($(R).USER_PLACEHOLDER),1),(r(!0),u(U,null,V(g.value,b=>(r(),u("option",{key:b.id,value:b.id},d(b.name),9,le))),128))],8,ne),[[Q,n.userId]]),n.errors.userId?(r(),u("div",ae,d(n.errors.userId),1)):L("",!0)]),t("button",{type:"submit",class:"btn-submit",disabled:n.submitting||!p.value},d(n.submitting?"投稿中...":"投稿"),9,re)])],32))}}),ie=k(de,[["__scopeId","data-v-c3a209f6"]]),ue={class:"modal-content"},ce={class:"todo-info"},me={class:"info-row"},ve={class:"title"},pe={class:"info-row"},fe={class:"description"},_e={class:"info-row"},ge={class:"status"},Te={class:"info-row"},ye={class:"info-row"},Ee={class:"info-row"},he={class:"comment-section"},be=I({__name:"TodoDetailModal",props:{todoId:{},isOpen:{type:Boolean}},emits:["close","todoUpdated"],setup(s,{emit:l}){const e=s,v=l,o=et(),_=K(),n=N(null);async function g(){try{const m=o.todos.find(c=>c.id===e.todoId);m&&(n.value=m)}catch(m){console.error("チケット詳細の取得に失敗しました:",m)}}function p(){v("close")}function a(){p()}async function i(){if(n.value)try{await o.toggleTodo(n.value.id),await g(),n.value&&v("todoUpdated",n.value)}catch(m){console.error("完了状態の切り替えに失敗しました:",m)}}function T(){}function b(m,c){if(!m&&!c)return"未設定";const S=m?E(m):"未設定",F=c?E(c):"未設定";return`${S} 〜 ${F}`}function E(m){return new Date(m).toLocaleDateString("ja-JP")}function f(m){return m?new Date(m).toLocaleString("ja-JP"):""}function h(m){m.key==="Escape"&&e.isOpen&&p()}return Z(()=>e.isOpen,async m=>{m?(await g(),document.addEventListener("keydown",h),document.body.style.overflow="hidden"):(_.clearComments(),document.removeEventListener("keydown",h),document.body.style.overflow="")}),Y(()=>{document.removeEventListener("keydown",h),document.body.style.overflow=""}),(m,c)=>(r(),M(lt,{to:"body"},[O(at,{name:"modal-fade"},{default:tt(()=>{var S,F,x,y,D,H,P,q,z;return[s.isOpen?(r(),u("div",{key:0,class:"modal-overlay",onClick:a},[t("div",{class:"modal-container",onClick:c[0]||(c[0]=J(()=>{},["stop"]))},[t("div",{class:"modal-header"},[c[1]||(c[1]=t("h2",null,"チケット詳細",-1)),t("button",{class:"close-button",onClick:p,"aria-label":"閉じる"}," × ")]),t("div",ue,[t("section",ce,[t("div",me,[c[2]||(c[2]=t("label",null,"タイトル:",-1)),t("p",ve,d((S=n.value)==null?void 0:S.title),1)]),t("div",pe,[c[3]||(c[3]=t("label",null,"説明:",-1)),t("p",fe,d(((F=n.value)==null?void 0:F.description)||"説明なし"),1)]),t("div",_e,[c[4]||(c[4]=t("label",null,"ステータス:",-1)),t("div",ge,[t("span",{class:G(["badge",(x=n.value)!=null&&x.completed?"completed":"pending"])},d((y=n.value)!=null&&y.completed?"完了":"未完了"),3),(D=n.value)!=null&&D.completed?L("",!0):(r(),u("button",{key:0,class:"btn-toggle",onClick:i}," 完了にする "))])]),t("div",Te,[c[5]||(c[5]=t("label",null,"期間:",-1)),t("p",null,d(b((H=n.value)==null?void 0:H.startDate,(P=n.value)==null?void 0:P.dueDate)),1)]),t("div",ye,[c[6]||(c[6]=t("label",null,"担当:",-1)),t("p",null,d(((q=n.value)==null?void 0:q.assigneeName)||"未割当"),1)]),t("div",Ee,[c[7]||(c[7]=t("label",null,"作成日時:",-1)),t("p",null,d(f((z=n.value)==null?void 0:z.createdAt)),1)])]),c[8]||(c[8]=t("hr",{class:"divider"},null,-1)),t("section",he,[t("h3",null,"コメント ("+d($(_).commentCount)+"件)",1),O(ie,{"todo-id":s.todoId,onCommentCreated:T},null,8,["todo-id"]),O(Wt,{"todo-id":s.todoId},null,8,["todo-id"])])])])])):L("",!0)]}),_:1})]))}}),Ce=k(be,[["__scopeId","data-v-b5b30149"]]),De={class:"container"},we={class:"project-subtitle"},$e={class:"back-link"},Ie=I({__name:"TodoView",setup(s){const l=rt(),e=et(),v=ot(),o=N(null),_=N("すべてのチケット"),n=N(null),g=N(!1),p=C(()=>e.filteredTodos),a=C(()=>e.stats),i=C(()=>e.loading),T=C(()=>e.error),b=C(()=>v.users),E=C({get:()=>e.filter,set:y=>e.setFilter(y)}),f=async()=>{const y=o.value;if(!y)_.value="すべてのチケット";else if(y==="none")_.value="案件なし（未分類）";else try{const D=await it(Number(y));_.value=D.name}catch{_.value="不明な案件"}},h=async y=>{try{await e.addTodo(y)}catch{}},m=async y=>{try{await e.toggleTodo(y)}catch{}},c=async y=>{try{await e.deleteTodo(y)}catch{}},S=y=>{n.value=y,g.value=!0},F=()=>{g.value=!1,n.value=null},x=()=>{e.fetchTodos(o.value)};return X(async()=>{o.value=l.query.projectId||null,await Promise.all([e.fetchTodos(o.value),v.fetchUsers(),f()])}),Z(()=>l.query.projectId,async y=>{o.value=y||null,await Promise.all([e.fetchTodos(o.value),f()])}),(y,D)=>{const H=dt("router-link");return r(),u("div",De,[D[2]||(D[2]=t("h1",null,"ToDoリスト",-1)),t("p",we,d(_.value),1),O(At,{total:a.value.total,completed:a.value.completed,pending:a.value.pending},null,8,["total","completed","pending"]),O(Et,{users:b.value,"project-id":o.value,onSubmit:h},null,8,["users","project-id"]),O(Mt,{modelValue:E.value,"onUpdate:modelValue":D[0]||(D[0]=P=>E.value=P)},null,8,["modelValue"]),O(ut,{message:T.value},null,8,["message"]),i.value?(r(),M(ct,{key:0})):(r(),M(Nt,{key:1,todos:p.value,onToggle:m,onDelete:c,onClick:S},null,8,["todos"])),t("div",$e,[O(H,{to:"/projects"},{default:tt(()=>[...D[1]||(D[1]=[B("← 案件一覧に戻る",-1)])]),_:1})]),n.value!==null?(r(),M(Ce,{key:2,"todo-id":n.value,"is-open":g.value,onClose:F,onTodoUpdated:x},null,8,["todo-id","is-open"])):L("",!0)])}}}),Fe=k(Ie,[["__scopeId","data-v-af76d275"]]);export{Fe as default};
